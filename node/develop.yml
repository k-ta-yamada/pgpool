common:
  vip: &vip 192.168.0.200
  database_users:
    superuser:            &superuser            postgres
    superuser_password:   &superuser_password   postgres
    replication_user:     &replication_user     repl
    replication_password: &replication_password repl
    xxx_check_user:       &xxx_check_user       pgpool
    xxx_check_password:   &xxx_check_password   pgpool
    recovery_user:        &recovery_user        postgres
    recovery_password:    &recovery_password    postgres

# ../cookbooks/hosts/default.rb
hosts:
  file_name:      /etc/hosts
  vip:
    - ip:   *vip
      host: pool
  frontend:
    - ip:   192.168.0.201
      host: pool1
    - ip:   192.168.0.202
      host: pool2
    - ip:   192.168.0.211
      host: pg1
    - ip:   192.168.0.212
      host: pg2
  backend_prefix: backend-
  backend:
    # - ip:   192.168.1.200
    #   host: pool
    - ip:   192.168.1.201
      host: pool1
    - ip:   192.168.1.202
      host: pool2
    - ip:   192.168.1.211
      host: pg1
    - ip:   192.168.1.212
      host: pg2

# ../cookbooks/postgresql/default.rb
postgresql:
  rpm:     https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-centos96-9.6-3.noarch.rpm
  pkg:
    - postgresql96
    - postgresql96-server
    - postgresql96-devel
    - postgresql96-libs
    - postgresql96-contrib
    - pgpool-II-96-extensions
  common:
    bindir:     /usr/pgsql-9.6/bin/
    pgdata:     &pgdata     /var/lib/pgsql/9.6/data/
    archivedir: &archivedir /var/lib/pgsql/9.6/archivedir/
    superuser:          *superuser
    superuser_password: *superuser_password
  initdb:
    su:
      user: postgres
    option:
      pgdata:   *pgdata
      encoding: UTF8
      locale:   C
      pwfile:   /var/lib/pgsql/pwfile
      username: *superuser
  pg_hba_conf:
    - type:        host
      database:    all
      user:        *superuser
      address:     192.168.0.0/24
      method_name: md5
    - type:        host
      database:    all
      user:        *recovery_user
      address:     192.168.1.0/24
      method_name: md5
    - type:        host
      database:    all
      user:        *xxx_check_user
      address:     192.168.1.0/24
      method_name: md5
    - type:        host
      database:    all
      user:        *replication_user
      address:     192.168.1.0/24
      method_name: md5
  postgresql_conf:
    listen_addresses:  "*"
    wal_level:         replica
    max_wal_senders:   2
    wal_keep_segments: 32
    archive_mode:      "on"
  recovery_1st_stage_sh:
    replication_user: *replication_user
  create_object:
    role:
      - name:     *replication_user
        password: *replication_password
        option:
          - LOGIN
          - REPLICATION
      - name:     *xxx_check_user
        password: *xxx_check_password
        option:
          - LOGIN
    extension:
      - name: pgpool_recovery
        dbname: template1
        # option: []

# ../cookbooks/pgpool-II/default.rb
pgpool:
  rpm: http://www.pgpool.net/yum/rpms/3.6/redhat/rhel-7-x86_64/pgpool-II-release-3.6-1.noarch.rpm
  pkg:
    - pgpool-II-pg96
    - pgpool-II-pg96-debuginfo
    - pgpool-II-pg96-devel
    - pgpool-II-pg96-extensions
  pcp_conf:
    - username: *recovery_user
      md5auth:  *recovery_password
    - username: *xxx_check_user
      md5auth:  *xxx_check_password
  pgpool_conf:
    delegate_ip:  *vip
    nic_dev_name: enp0s8
    # NOTE: /etc/hostsに記載のバックエンドのalias名を使用すること
    backend_hostname0: backend-pg1
    backend_data_directory0: /var/lib/pgsql/9.6/data/
    # NOTE: /etc/hostsに記載のバックエンドのalias名を使用すること
    backend_hostname1: backend-pg2
    backend_data_directory1: /var/lib/pgsql/9.6/data/
    log_destination:       syslog,stderr
    sr_check_user:         *xxx_check_user
    sr_check_password:     *xxx_check_password
    sr_check_database:     postgres
    health_check_user:     *xxx_check_user
    health_check_password: *xxx_check_password
    failover_command:      /etc/pgpool-II/failover.sh %d %P %H %R
    recovery_user:         *recovery_user
    recovery_password:     *recovery_password
    recovery_1st_stage_command: recovery_1st_stage.sh
    recovery_2nd_stage_command: recovery_2nd_stage.sh
  pool_hba_conf:
    - type:        host
      database:    all
      user:        *xxx_check_user
      address:     0.0.0.0/0
      method_name: md5
    - type:        host
      database:    all
      user:        *recovery_user
      address:     0.0.0.0/0
      method_name: md5
  pool_passwd:
    - username: *recovery_user
      md5auth:  *recovery_password
    - username: *xxx_check_user
      md5auth:  *xxx_check_password
